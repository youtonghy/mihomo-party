<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>面板</title>
    <link rel="stylesheet" href="assets/styles.css" />
    <style>
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .info-item { padding: 15px; background: #f8f9fa; border-radius: 6px; }
        .info-label { color: #666; font-size: 14px; margin-bottom: 5px; }
        .info-value { color: #333; font-size: 16px; font-weight: 600; }
        .subscription-links { display: flex; flex-direction: column; gap: 15px; }
        .link-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 6px; }
        .link-info { flex: 1; }
        .link-label { font-weight: 600; color: #333; margin-bottom: 5px; }
        .link-url { color: #2563eb; font-size: 14px; word-break: break-all; cursor: pointer; transition: opacity 0.2s; }
        .link-url:hover { opacity: 0.7; text-decoration: underline; }
        .copy-btn, .import-btn { padding: 8px 15px; border-radius: 4px; margin-left: 10px; font-size: 14px; }
        .avatar { width: 60px; height: 60px; border-radius: 50%; margin-bottom: 15px; }
        .user-header { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
        /* 使用全局 styles.css 中的 .traffic-info / .traffic-item / .traffic-number / .traffic-label 蓝色 3D 风格 */
        .traffic-info { margin-top: 20px; }
        .sub-icon { width: 40px; height: 40px; object-fit: contain; display: inline-block; margin-bottom: 8px; }
        .modal-overlay { max-height: none; }
    </style>
</head>
<body>
    <script src="config.js"></script>
    <div class="header">
        <h1>面板</h1>
        <button class="menu-toggle" id="menuToggleBtn" aria-label="切换菜单" aria-expanded="false" title="菜单">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>
        <nav class="nav" role="navigation" aria-label="主导航">
            <a class="nav-btn active" href="dashboard.html" title="面板">
                <!-- grid/dashboard icon -->
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <rect x="3" y="3" width="7" height="7" rx="1"></rect>
                    <rect x="14" y="3" width="7" height="7" rx="1"></rect>
                    <rect x="14" y="14" width="7" height="7" rx="1"></rect>
                    <rect x="3" y="14" width="7" height="7" rx="1"></rect>
                </svg>
                <span>面板</span>
            </a>
            <a class="nav-btn" href="shop.html" title="商店">
                <!-- shopping bag icon -->
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M6 2h12"/>
                    <path d="M3 6h18l-1.5 14a2 2 0 0 1-2 2H6.5a2 2 0 0 1-2-1.8L3 6z"/>
                    <path d="M16 10a4 4 0 0 1-8 0"/>
                </svg>
                <span>商店</span>
            </a>
            <a class="nav-btn" href="node.html" title="节点">
                <!-- server/node icon -->
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <rect x="3" y="4" width="18" height="6" rx="2"/>
                    <rect x="3" y="14" width="18" height="6" rx="2"/>
                    <path d="M7 8h.01M11 8h.01M7 18h.01M11 18h.01"/>
                </svg>
                <span>节点</span>
            </a>
            <a class="nav-btn" href="ticket.html" title="工单">
                <!-- help/circle icon -->
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <circle cx="12" cy="12" r="9"></circle>
                    <path d="M12 8a2.5 2.5 0 0 1 2 2.5c0 1.5-2 1.5-2 3"/>
                    <circle cx="12" cy="16.5" r=".8"></circle>
                </svg>
                <span>工单</span>
            </a>
        </nav>
        <a class="avatar-link" href="user.html" title="个人中心"><span class="avatar-circle" aria-hidden="true">我</span></a>
    </div>

    <div class="container">
        <!-- 公告模块 -->
        <div class="module" id="noticeModule">
            <h2 class="module-title">公告</h2>
            <div id="noticeLoading" class="loading">加载中...</div>
            <div id="noticeContent" style="display: none;">
                <div class="traffic-info" id="noticeGrid"></div>
            </div>
        </div>
        <!-- 用户信息模块 -->
        <div class="module" id="userInfoModule">
            <h2 class="module-title">流量信息</h2>
            <div id="userInfoLoading" class="loading">加载中...</div>
            <div id="userInfoContent" style="display: none;">
                <div class="traffic-info">
                    <div class="traffic-item">
                        <div class="traffic-number" id="usedTraffic">-</div>
                        <div class="traffic-label">已用流量</div>
                    </div>
                    <div class="traffic-item">
                        <div class="traffic-number" id="availableTraffic">-</div>
                        <div class="traffic-label">可用流量</div>
                    </div>
                    <div class="traffic-item">
                        <div class="traffic-number" id="expireDate">-</div>
                        <div class="traffic-label">到期时间</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 订阅链接模块 -->
        <div class="module" id="subscriptionModule">
            <h2 class="module-title">订阅链接</h2>
            <div id="subscriptionLoading" class="loading">加载中...</div>
            <div id="subscriptionContent" style="display: none;">
                <div class="traffic-info" id="subscriptionGrid"></div>
            </div>
        </div>
        
        <!-- 流量记录模块（从 traffic.html 移植） -->
        <div class="module" id="trafficModule">
            <h2 class="module-title">流量记录</h2>
            <div class="table-controls">
                <div>
                    <button class="btn" id="prevPageBtn" type="button">上一页</button>
                    <button class="btn" id="nextPageBtn" type="button">下一页</button>
                </div>
                <div>
                    <label>
                        每页
                        <select id="pageSizeSelect" class="select">
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                        </select>
                        条
                    </label>
                </div>
            </div>
            <div id="trafficLoading" class="loading">加载中...</div>
            <div id="trafficError" class="error" style="display:none;"></div>
            <div id="trafficContent" style="display:none;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>时间</th>
                            <th>上行</th>
                            <th>下行</th>
                            <th>合计</th>
                        </tr>
                    </thead>
                    <tbody id="trafficTbody"></tbody>
                </table>
                <div id="trafficEmpty" class="table-empty" style="display:none;">暂无记录</div>
            </div>
        </div>
    </div>

    <script>
        // Cookie操作函数
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        function deleteCookie(name) {
            document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
        }

        // 格式化流量
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 格式化日期
        function formatDate(timestamp) {
            if (!timestamp) return '长期有效';
            const date = new Date(timestamp * 1000);
            return date.toLocaleDateString('zh-CN');
        }
        // 格式化日期时间（移植自 traffic.html）
        function formatDateTime(ts){ if(!ts) return '-'; const d=new Date((String(ts).length>10?Number(ts):Number(ts)*1000)); return d.toLocaleString('zh-CN'); }

        // 复制到剪贴板（与 user.html 邀请码一致：Clipboard API 优先，textarea 兜底）
        async function copyTextToClipboard(text){
            try{
                if(navigator.clipboard && window.isSecureContext){
                    await navigator.clipboard.writeText(text);
                }else{
                    const ta=document.createElement('textarea');
                    ta.value=text; ta.style.position='fixed'; ta.style.left='-9999px';
                    document.body.appendChild(ta); ta.focus(); ta.select();
                    document.execCommand('copy'); document.body.removeChild(ta);
                }
                return true;
            }catch{
                return false;
            }
        }

        // 一键导入
        function importToClient(type, url) {
            const encodedUrl = encodeURIComponent(url);
            let importUrl = '';
            
            switch(type) {
                case 'clash':
                    importUrl = `clash://install-config?url=${encodedUrl}`;
                    break;
                case 'shadowrocket':
                    importUrl = `shadowrocket://add/sub://${btoa(url)}?remarks=V2Board`;
                    break;
                case 'ssr':
                    importUrl = `sub://${btoa(url)}`;
                    break;
                default:
                    // 无匹配客户端，默认复制链接
                    copyTextToClipboard(url);
                    return;
            }
            
            window.location.href = importUrl;
        }

        // 获取Token
        const token = getCookie('auth_token');
        if (!token) {
            window.location.href = 'login.html';
        }

        // API请求函数
        async function apiRequest(endpoint) {
            const response = await fetch(`${window.API_BASE}${endpoint}`, {
                headers: {
                    'Authorization': token
                }
            });
            
            if (response.status === 401) {
                deleteCookie('auth_token');
                window.location.href = 'login.html';
                return null;
            }
            
            const data = await response.json();
            return data.data;
        }
        // 带查询参数的 GET（供流量记录使用）
        async function apiRequestWithParams(endpoint, params){
            let url = `${window.API_BASE}${endpoint}`;
            if(params && typeof params==='object'){
                const usp = new URLSearchParams();
                Object.keys(params).forEach(k=>{ if(params[k]!==undefined && params[k]!==null) usp.append(k, params[k]); });
                const qs = usp.toString();
                if(qs) url += (url.includes('?')?'&':'?') + qs;
            }
            const response = await fetch(url, { headers: { 'Authorization': token }});
            if (response.status === 401) { deleteCookie('auth_token'); window.location.href='login.html'; return null; }
            const data = await response.json().catch(()=>({}));
            return data.data;
        }

        // 加载用户信息（从 getSubscribe 获取并计算已用/可用/到期）
        async function loadUserInfo() {
            try {
                const sub = await apiRequest('/api/v1/user/getSubscribe');

                if (sub) {
                    const used = (Number(sub.u) || 0) + (Number(sub.d) || 0);
                    const total = Number(sub.transfer_enable) || 0;
                    const available = Math.max(total - used, 0);

                    document.getElementById('usedTraffic').textContent = formatBytes(used);
                    document.getElementById('availableTraffic').textContent = formatBytes(available);
                    document.getElementById('expireDate').textContent = formatDate(sub.expired_at);
                }

                document.getElementById('userInfoLoading').style.display = 'none';
                document.getElementById('userInfoContent').style.display = 'block';
            } catch (error) {
                console.error('加载用户信息失败:', error);
                document.getElementById('userInfoLoading').textContent = '加载失败，请刷新页面';
            }
        }

        // 加载订阅链接（卡片样式，点击弹窗详情）
        async function loadSubscriptionLinks() {
            try {
                const subscribeData = await apiRequest('/api/v1/user/getSubscribe');
                if (subscribeData && subscribeData.subscribe_url) {
                    const baseUrl = subscribeData.subscribe_url;
                    const gridEl = document.getElementById('subscriptionGrid');

                    const clientTypes = [
                        { name: 'Clash Meta', type: 'clash', flag: 'meta', icon: 'assets/cat.png' },
                        { name: 'Shadowrocket', type: 'shadowrocket', flag: 'shadowrocket', icon: 'assets/rocket1.png' },
                        { name: 'Sing Box', type: 'sb', flag: 'sing-box', icon: 'assets/box.png' },
                    ];

                    const items = [
                        { name: '通用订阅', type: 'generic', url: baseUrl, icon: 'assets/common.png' },
                        ...clientTypes.map(c => ({ name: `${c.name} 订阅`, type: c.type, url: `${baseUrl}&flag=${c.flag}`, icon: c.icon }))
                    ];

                    gridEl.innerHTML = items.map(item => `
                        <div class="traffic-item subscription-item" role="button" tabindex="0" aria-label="查看订阅"
                             data-name="${item.name}" data-url="${encodeURIComponent(item.url)}" data-type="${item.type}">
                            ${item.icon ? `<img class=\"sub-icon\" src=\"${item.icon}\" alt=\"${item.name}图标\">` : ''}
                            <div class="traffic-number" style="font-size:18px;">${item.name}</div>
                            <div class="traffic-label">点击查看</div>
                        </div>
                    `).join('');

                    gridEl.querySelectorAll('.subscription-item').forEach(el => {
                        const name = el.getAttribute('data-name');
                        const url = decodeURIComponent(el.getAttribute('data-url'));
                        const type = el.getAttribute('data-type');
                        const open = () => openSubscriptionModal(name, url, type);
                        el.addEventListener('click', open);
                        el.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); open(); } });
                    });
                }

                document.getElementById('subscriptionLoading').style.display = 'none';
                document.getElementById('subscriptionContent').style.display = 'block';
            } catch (error) {
                console.error('加载订阅链接失败:', error);
                document.getElementById('subscriptionLoading').textContent = '加载失败，请刷新页面';
            }
        }

        function openSubscriptionModal(name, url, type) {
            const overlay = document.getElementById('noticeModal');
            const titleEl = document.getElementById('modalTitle');
            const bodyEl = document.getElementById('modalBody');
            titleEl.textContent = `订阅详情 - ${name}`;

            const canImport = ['clash', 'shadowrocket', 'ssr', 'surfboard'].includes(type);
            bodyEl.innerHTML = `
                <div>
                    <div style="margin: 8px 0; color:#374151; font-weight:600;">订阅链接</div>
                    <div id="subscriptionDetailUrl" class="subscription-url"></div>
                    <div style="margin-top: 12px;">
                        <button class="copy-btn" id="subscriptionCopyBtn">复制链接</button>
                        ${canImport ? '<button class="import-btn" id="subscriptionImportBtn">一键导入</button>' : ''}
                    </div>
                </div>
            `;
            const urlEl = document.getElementById('subscriptionDetailUrl');
            if (urlEl) urlEl.textContent = url;
            const copyBtn = document.getElementById('subscriptionCopyBtn');
            if (copyBtn) {
                copyBtn.addEventListener('click', async () => {
                    const oldText = copyBtn.textContent;
                    copyBtn.disabled = true;
                    const ok = await copyTextToClipboard(url);
                    copyBtn.textContent = ok ? '已复制' : '复制失败';
                    setTimeout(() => { copyBtn.textContent = oldText; copyBtn.disabled = false; }, 1200);
                });
            }
            const importBtn = document.getElementById('subscriptionImportBtn');
            if (importBtn) importBtn.addEventListener('click', () => importToClient(type, url));

            overlay.style.display = 'flex';
        }

        // 公告：安全渲染（移除 img/script）
        function sanitizeHtml(html) {
            if (!html) return '';
            let s = String(html);
            s = s.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, '');
            s = s.replace(/<img[^>]*>/gi, '');
            return s;
        }

        async function loadNotices() {
            const loadingEl = document.getElementById('noticeLoading');
            const contentEl = document.getElementById('noticeContent');
            const gridEl = document.getElementById('noticeGrid');
            try {
                const resp = await apiRequest('/api/v1/user/notice/fetch');
                const notices = Array.isArray(resp) ? resp : (resp && resp.data) || [];
                if (!notices || notices.length === 0) {
                    gridEl.innerHTML = '<div class="error" style="border:none;padding:0;">暂无公告</div>';
                } else {
                    // 仅显示标题为小卡片
                    window.__noticeCache = {};
                    gridEl.innerHTML = notices.filter(n => n.show !== 0).map(n => {
                        const id = n.id ?? Math.random().toString(36).slice(2);
                        window.__noticeCache[id] = n;
                        const safeTitle = (n.title || '公告').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                        return `
                            <div class="traffic-item notice-item" data-id="${id}" role="button" tabindex="0" aria-label="查看公告">
                                <div class="traffic-number" style="font-size:18px;">${safeTitle}</div>
                                <div class="traffic-label">点击查看</div>
                            </div>
                        `;
                    }).join('');
                    // 绑定事件
                    gridEl.querySelectorAll('.notice-item').forEach(item => {
                        const id = item.getAttribute('data-id');
                        const open = () => openNoticeModal(window.__noticeCache[id]);
                        item.addEventListener('click', open);
                        item.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); open(); } });
                    });
                }
                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';
            } catch (e) {
                console.error('加载公告失败:', e);
                loadingEl.textContent = '加载失败，请刷新页面';
            }
        }

        function openNoticeModal(notice) {
            if (!notice) return;
            const overlay = document.getElementById('noticeModal');
            const titleEl = document.getElementById('modalTitle');
            const bodyEl = document.getElementById('modalBody');
            titleEl.textContent = notice.title || '公告';
            bodyEl.innerHTML = sanitizeHtml(notice.content || '');
            overlay.style.display = 'flex';
        }
        
        // ===== 流量记录逻辑（移植） =====
        function normalizeTraffic(resp){
            if(Array.isArray(resp)) return { list: resp, total: undefined };
            if(resp && Array.isArray(resp.list)) return { list: resp.list, total: resp.total };
            if(resp && Array.isArray(resp.data)) return { list: resp.data, total: resp.total };
            if(resp && resp.data && Array.isArray(resp.data.list)) return { list: resp.data.list, total: resp.data.total };
            return { list: [], total: undefined };
        }
        function renderTraffic(list){
            const tbody = document.getElementById('trafficTbody');
            const empty = document.getElementById('trafficEmpty');
            if(!list || list.length===0){ tbody.innerHTML=''; empty.style.display='block'; return; }
            empty.style.display='none';
            tbody.innerHTML = list.map(item=>{
                const ts = item.record_at || item.created_at || item.time || item.date || item.datetime || item.ts;
                const u = (item.u!==undefined)? item.u : (item.up!==undefined? item.up : 0);
                const d = (item.d!==undefined)? item.d : (item.down!==undefined? item.down : 0);
                const total = (Number(u)||0) + (Number(d)||0);
                return `
                    <tr>
                        <td>${formatDateTime(ts)}</td>
                        <td>${formatBytes(u)}</td>
                        <td>${formatBytes(d)}</td>
                        <td>${formatBytes(total)}</td>
                    </tr>
                `;
            }).join('');
        }
        let currentPage = 1;
        let pageSize = 10;
        async function loadTraffic(){
            const loadingEl = document.getElementById('trafficLoading');
            const contentEl = document.getElementById('trafficContent');
            const errorEl = document.getElementById('trafficError');
            try{
                const resp = await apiRequestWithParams('/api/v1/user/stat/getTrafficLog', { current: currentPage, pageSize });
                const { list } = normalizeTraffic(resp);
                renderTraffic(list);
                loadingEl.style.display='none';
                errorEl.style.display='none';
                contentEl.style.display='block';
            }catch(err){
                console.error('加载流量记录失败:', err);
                loadingEl.style.display='none';
                errorEl.textContent='加载失败，请稍后重试';
                errorEl.style.display='block';
            }
        }

        function closeNoticeModal() {
            const overlay = document.getElementById('noticeModal');
            overlay.style.display = 'none';
        }

        // 退出登录
        function logout() {
            deleteCookie('auth_token');
            window.location.href = 'login.html';
        }

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            loadNotices();
            loadUserInfo();
            loadSubscriptionLinks();
            // 公告弹窗事件
            const modal = document.createElement('div');
            modal.id = 'noticeModal';
            modal.className = 'modal-overlay';
            modal.style.display = 'none';
            modal.innerHTML = `
                <div class="modal-dialog" role="dialog" aria-modal="true">
                    <div class="modal-header">
                        <span id="modalTitle"></span>
                        <button class="modal-close" id="modalCloseBtn" aria-label="关闭">×</button>
                    </div>
                    <div class="modal-body" id="modalBody"></div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeNoticeModal(); });
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeNoticeModal(); });
            modal.querySelector('#modalCloseBtn').addEventListener('click', closeNoticeModal);

            // 移动端导航展开/收起
            const headerEl = document.querySelector('.header');
            const navEl = document.querySelector('.nav');
            const toggleBtn = document.getElementById('menuToggleBtn');
            if (toggleBtn && headerEl && navEl) {
                const closeNav = () => {
                    headerEl.classList.remove('nav-open');
                    toggleBtn.setAttribute('aria-expanded', 'false');
                };
                toggleBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const open = !headerEl.classList.contains('nav-open');
                    headerEl.classList.toggle('nav-open');
                    toggleBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
                });
                // 点击导航项自动收起
                navEl.addEventListener('click', (e) => {
                    if (e.target && e.target.closest('a.nav-btn')) closeNav();
                });
                // 点击外部收起
                document.addEventListener('click', (e) => {
                    if (!headerEl.contains(e.target)) closeNav();
                });
                // Esc 收起
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') closeNav();
                });
                // 视口变宽时收起
                window.addEventListener('resize', () => {
                    if (window.innerWidth > 900) closeNav();
                });
            }
            
            // 流量记录事件与加载
            loadTraffic();
            document.getElementById('prevPageBtn').addEventListener('click', function(){ if(currentPage>1){ currentPage-=1; document.getElementById('trafficLoading').style.display='block'; loadTraffic(); } });
            document.getElementById('nextPageBtn').addEventListener('click', function(){ currentPage+=1; document.getElementById('trafficLoading').style.display='block'; loadTraffic(); });
            document.getElementById('pageSizeSelect').addEventListener('change', function(e){ pageSize = Number(e.target.value)||10; currentPage=1; document.getElementById('trafficLoading').style.display='block'; loadTraffic(); });
        });
    </script>
</body>
</html>