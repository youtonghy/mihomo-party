<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录面板</title>
    <link rel="stylesheet" href="assets/styles.css" />
    <style>
        body { display: flex; align-items: center; justify-content: center; }
        .login-container { background: transparent; padding: 10px; border-radius: 10px; width: 100%; max-width: 960px; }
        .login-title { text-align: center; margin-bottom: 30px; color: #333; font-size: 24px; font-weight: 600; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; color: #555; font-weight: 500; }
        .form-input { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; transition: border-color 0.3s; }
        .form-input:focus { outline: none; border-color: #10b981; }
        .login-btn { width: 100%; }
        .error-message { color: #e74c3c; text-align: center; margin-top: 10px; font-size: 14px; }
        .success-message { color: #27ae60; text-align: center; margin-top: 10px; font-size: 14px; }
        .inline-group { display: flex; gap: 10px; align-items: center; }
        .inline-group .form-input { flex: 1; }
        .auth-split { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; align-items: stretch; }
        .auth-card { position: relative; background: #fff; padding: 28px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); height: 100%; display: flex; flex-direction: column; overflow: visible; }
        .auth-card.login-card { justify-content: center; }
        .card-badge { position: absolute; top: -10px; left: -10px; padding: 8px 12px; font-size: 12px; font-weight: 800; color: #fff; border-radius: 6px; box-shadow: 0 4px 10px rgba(0,0,0,0.12); border: 1px solid rgba(255,255,255,0.6); z-index: 2; }
        .badge-login { background: linear-gradient(135deg, #10b981, #059669); }
        .badge-register { background: linear-gradient(135deg, #34d399, #10b981); }
        @media (max-width: 720px) { .auth-split { grid-template-columns: 1fr; } }
        .helper { text-align: center; margin-top: 12px; font-size: 14px; }
        .helper a { color: #10b981; text-decoration: none; }
        .helper a:hover { text-decoration: underline; }

        /* 触发区：默认仅展示两个按钮 */
        .trigger-wrap { display: flex; gap: 24px; align-items: center; justify-content: center; padding: 60px 0; }
        .action-btn {
          display: inline-flex; flex-direction: column; align-items: center; justify-content: center; gap: 14px;
          width: 260px; height: 180px; border-radius: 20px;
          background: linear-gradient(135deg, #eef2ff, #e0e7ff 60%, #e0f2fe);
          color: #1e3a8a; border: 2px solid #bfdbfe; cursor: pointer;
          font-size: 20px; font-weight: 900; text-align: center;
          box-shadow: 0 8px 0 #93c5fd, 0 16px 36px rgba(37,99,235,0.16);
          transition: transform .12s ease, box-shadow .18s ease, filter .18s ease;
        }
        .action-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 0 #93c5fd, 0 24px 44px rgba(37,99,235,0.22); filter: saturate(1.05); }
        .action-btn:active { transform: translateY(0); box-shadow: 0 6px 0 #93c5fd, 0 16px 30px rgba(37,99,235,0.18); }
        .action-btn:focus { outline: 3px solid #93c5fd; outline-offset: 2px; }
        .action-btn img { width: 96px; height: 96px; object-fit: contain; filter: drop-shadow(0 6px 12px rgba(37,99,235,0.18)); }
        @media (max-width: 880px) { .trigger-wrap { padding: 40px 0; } .action-btn { width: 220px; height: 160px; font-size: 18px; } .action-btn img{ width:88px; height:88px; } }
        @media (max-width: 520px) { .action-btn { width: 44vw; min-width: 160px; height: 140px; font-size: 16px; } .action-btn img{ width:78px; height:78px; } }

        /* 登录/注册模态背景优化（本页特有） */
        .auth-modal { 
          background:
            radial-gradient(1000px 600px at 50% -10%, rgba(147,197,253,0.18), transparent 60%),
            rgba(0, 10, 25, 0.45);
          backdrop-filter: blur(6px) saturate(1.05);
        }
        .auth-modal .modal-dialog { 
          position: relative;
          background: linear-gradient(180deg, #ffffff 0%, #f8fbff 58%, #eef4ff 100%);
          border: 2px solid #bfdbfe; border-radius: 18px;
          box-shadow: 0 14px 46px rgba(37,99,235,0.26), 0 6px 0 #93c5fd;
        }
        .auth-modal .modal-dialog::before{
          content: ""; position: absolute; inset: -10px; border-radius: 22px; z-index: -1;
          background: radial-gradient(60% 40% at 50% -10%, rgba(147,197,253,0.35), transparent 70%);
          filter: blur(8px);
        }
        .auth-modal .modal-header{ background: transparent; border-bottom: 2px solid #bfdbfe; }
    </style>
</head>
<body>
    <script src="config.js"></script>
    <script>
        // 将注册页配置暴露到本页使用
        const REGISTER_SHOW_INVITE = (window.REGISTER_SHOW_INVITE ?? false);
        const REGISTER_INVITE_REQUIRED = (window.REGISTER_INVITE_REQUIRED ?? false);
        const REGISTER_SHOW_EMAIL_CODE = (window.REGISTER_SHOW_EMAIL_CODE ?? false);
        const RECAPTCHA_SITE_KEY = (window.RECAPTCHA_SITE_KEY || '');
    </script>
    <div class="login-container">
        <div class="trigger-wrap">
            <button class="action-btn" id="openLogin" aria-label="登录">
              <img src="assets/login.png" alt="登录图标" />
              <span>登录</span>
            </button>

            <button class="action-btn" id="openRegister" aria-label="注册">
              <img src="assets/registe.png" alt="注册图标" />
              <span>注册</span>
            </button>
        </div>
    </div>

    <!-- 登录模态 -->
    <div class="modal-overlay auth-modal" id="loginModal">
      <div class="modal-dialog" style="max-width: 520px;">
        <div class="auth-card login-card" style="box-shadow:none; border-radius:0;">
            <h2 class="login-title" style="margin-top:10px;">用户登录</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="email">邮箱</label>
                    <input type="email" id="email" class="form-input" placeholder="请输入邮箱" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="password">密码</label>
                    <input type="password" id="password" class="form-input" placeholder="请输入密码" required>
                </div>
                <button type="submit" class="btn login-btn" id="loginBtn">登录</button>
                <div id="message" class="error-message"></div>
            </form>
        </div>
      </div>
    </div>

    <!-- 注册模态 -->
    <div class="modal-overlay auth-modal" id="registerModal">
      <div class="modal-dialog" style="max-width: 560px;">
        <div class="auth-card" id="register" style="box-shadow:none; border-radius:0;">
            <h2 class="login-title" style="margin-top:10px;">用户注册</h2>
            <form id="registerForm">
                <div class="form-group">
                    <label class="form-label" for="reg_email">邮箱</label>
                    <input type="email" id="reg_email" class="form-input" placeholder="请输入邮箱" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="reg_password">密码</label>
                    <input type="password" id="reg_password" class="form-input" placeholder="请输入密码" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="reg_auth_password">确认密码</label>
                    <input type="password" id="reg_auth_password" class="form-input" placeholder="请再次输入密码" required>
                </div>
                <div class="form-group" id="reg_inviteWrapper" style="display:none;">
                    <label class="form-label" for="reg_invite_code">邀请码</label>
                    <input type="text" id="reg_invite_code" class="form-input" placeholder="请输入邀请码">
                </div>
                <div class="form-group" id="reg_emailCodeWrapper" style="display:none;">
                    <label class="form-label" for="reg_email_code">邮箱验证码</label>
                    <div class="inline-group">
                        <input type="text" id="reg_email_code" class="form-input" placeholder="请输入邮箱验证码">
                        <button type="button" class="btn" id="reg_sendCodeBtn">发送</button>
                    </div>
                </div>
                <button type="submit" class="btn login-btn" id="reg_registerBtn">注册</button>
                <div id="reg_message" class="error-message"></div>
            </form>
        </div>
      </div>
    </div>

    <script>
        // 设置Cookie
        function setCookie(name, value, days) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
        }

        // 获取Cookie
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        // 检查是否已登录：若已有 Cookie 直接跳转
        function checkLoginStatus() {
            const token = getCookie('auth_token');
            if (token) {
                window.location.href = '/dashboard.html';
            }
        }

        // 打开/关闭模态
        const loginModal = document.getElementById('loginModal');
        const registerModal = document.getElementById('registerModal');
        document.getElementById('openLogin').addEventListener('click', ()=>{ loginModal.style.display='flex'; });
        document.getElementById('openRegister').addEventListener('click', ()=>{ registerModal.style.display='flex'; });
        loginModal.addEventListener('click', (e)=>{ if(e.target===loginModal) loginModal.style.display='none'; });
        registerModal.addEventListener('click', (e)=>{ if(e.target===registerModal) registerModal.style.display='none'; });

        // 登录处理
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            const message = document.getElementById('message');
            
            // 禁用按钮
            loginBtn.disabled = true;
            loginBtn.textContent = '登录中...';
            message.textContent = '';
            
            try {
                const response = await fetch(`${window.API_BASE}/api/v1/passport/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        email: email,
                        password: password
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.data) {
                    // 登录成功，保存token到Cookie
                    setCookie('auth_token', data.data.auth_data, 7);
                    
                    message.textContent = '登录成功！';
                    message.className = 'success-message';
                    
                    // 延迟跳转
                    setTimeout(() => {
                        window.location.href = '/dashboard.html';
                    }, 1000);
                } else {
                    // 登录失败
                    message.textContent = data.message || '登录失败，请检查邮箱和密码';
                    message.className = 'error-message';
                }
            } catch (error) {
                message.textContent = '网络错误，请稍后重试';
                message.className = 'error-message';
            } finally {
                // 恢复按钮状态
                loginBtn.disabled = false;
                loginBtn.textContent = '登录';
            }
        });

        // 注册区域初始化（显隐、必填设置）
        (function initRegisterUI(){
            const inviteWrapper = document.getElementById('reg_inviteWrapper');
            const inviteInput = document.getElementById('reg_invite_code');
            const emailCodeWrapper = document.getElementById('reg_emailCodeWrapper');
            const emailCodeInput = document.getElementById('reg_email_code');

            if (REGISTER_SHOW_INVITE) {
                inviteWrapper.style.display = '';
                if (REGISTER_INVITE_REQUIRED) inviteInput.setAttribute('required','required');
            }
            if (REGISTER_SHOW_EMAIL_CODE) {
                emailCodeWrapper.style.display = '';
                emailCodeInput.setAttribute('required','required');
            }
        })();

        // reCAPTCHA 支持
        let recaptchaReady = false;
        if (RECAPTCHA_SITE_KEY) {
            const s = document.createElement('script');
            s.src = `https://www.google.com/recaptcha/api.js?render=${encodeURIComponent(RECAPTCHA_SITE_KEY)}`;
            s.async = true;
            s.onload = () => { recaptchaReady = true; };
            document.head.appendChild(s);
        }

        async function getRecaptchaToken(){
            if (!RECAPTCHA_SITE_KEY || !recaptchaReady || !window.grecaptcha) return '';
            try { return await window.grecaptcha.execute(RECAPTCHA_SITE_KEY, { action: 'register' }); } catch(_) { return ''; }
        }

        // 发送邮箱验证码
        (function initSendCode(){
            const sendBtn = document.getElementById('reg_sendCodeBtn');
            if (!sendBtn) return;
            let timer = null;
            function startCountdown(sec){
                let left = sec; sendBtn.disabled = true; sendBtn.textContent = `重新发送(${left}s)`;
                timer = setInterval(()=>{ left -= 1; if(left<=0){ clearInterval(timer); sendBtn.disabled=false; sendBtn.textContent='发送'; } else { sendBtn.textContent = `重新发送(${left}s)`; } }, 1000);
            }
            sendBtn.addEventListener('click', async ()=>{
                const email = document.getElementById('reg_email').value.trim();
                const msg = document.getElementById('reg_message');
                msg.textContent = '';
                if(!email){ msg.textContent='请先填写邮箱'; msg.className='error-message'; return; }
                try{
                    sendBtn.disabled = true; sendBtn.textContent='发送中...';
                    const recaptcha_data = await getRecaptchaToken();
                    const resp = await fetch(`${window.API_BASE}/api/v1/passport/comm/sendEmailVerify`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, recaptcha_data: recaptcha_data || '' })
                    });
                    const data = await resp.json().catch(()=>({}));
                    if(resp.ok){ msg.textContent = data.message || '验证码已发送，请查收邮箱'; msg.className='success-message'; startCountdown(60); }
                    else { msg.textContent = data.message || '发送失败，请稍后重试'; msg.className='error-message'; sendBtn.disabled=false; sendBtn.textContent='发送'; }
                }catch(_){ const msg = document.getElementById('reg_message'); msg.textContent='网络错误，发送失败'; msg.className='error-message'; sendBtn.disabled=false; sendBtn.textContent='发送'; }
            });
        })();

        // 注册提交
        document.getElementById('registerForm').addEventListener('submit', async function(e){
            e.preventDefault();
            const email = document.getElementById('reg_email').value.trim();
            const password = document.getElementById('reg_password').value;
            const auth_password = document.getElementById('reg_auth_password').value;
            const invite_code = document.getElementById('reg_invite_code')?.value.trim() || '';
            const email_code = document.getElementById('reg_email_code')?.value.trim() || '';
            const registerBtn = document.getElementById('reg_registerBtn');
            const message = document.getElementById('reg_message');

            message.textContent = '';
            if(password !== auth_password){ message.textContent='两次输入的密码不一致'; message.className='error-message'; return; }
            if(REGISTER_SHOW_INVITE && REGISTER_INVITE_REQUIRED && !invite_code){ message.textContent='请填写邀请码'; message.className='error-message'; return; }
            if(REGISTER_SHOW_EMAIL_CODE && !email_code){ message.textContent='请填写邮箱验证码'; message.className='error-message'; return; }

            registerBtn.disabled = true; registerBtn.textContent='注册中...';
            try{
                const recaptcha_data = await getRecaptchaToken();
                const payload = { email, password, auth_password, invite_code: REGISTER_SHOW_INVITE ? invite_code : '', email_code: REGISTER_SHOW_EMAIL_CODE ? email_code : '', recaptcha_data: recaptcha_data || '' };
                const resp = await fetch(`${window.API_BASE}/api/v1/passport/auth/register`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                const data = await resp.json().catch(()=>({}));
                if(resp.ok){ message.textContent = data.message || '注册成功，正在为您登录...'; message.className='success-message'; setTimeout(()=>{ window.location.href='/login.html'; }, 1000); }
                else { message.textContent = data.message || '注册失败，请检查信息后重试'; message.className='error-message'; }
            }catch(_){ message.textContent='网络错误，请稍后重试'; message.className='error-message'; }
            finally { registerBtn.disabled=false; registerBtn.textContent='注册'; }
        });

        // 页面加载时检查登录状态
        checkLoginStatus();
    </script>
</body>
</html>